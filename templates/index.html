<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Freshness Detector</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="theme-toggle">
        <button id="dark-mode-toggle" class="dark-mode-btn">ğŸŒ™</button>
    </div>

    <div class="container">
        <h1>ğŸ Fruit Freshness Detector</h1>
        <p class="subtitle">Analyze if your fruit is fresh or rotten using AI</p>

        <!-- Language Selector -->
        <div class="language-selector">
            <label for="language">ğŸŒ Language:</label>
            <select id="language" class="language-dropdown">
                {% for code, name in languages.items() %}
                    <option value="{{ code }}" {% if code == 'en' %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>

        {% if result %}
            <div class="result-box">
                <h2>Analysis Results</h2>
                <div class="result-content">
                    {{ result|safe }}
                </div>
                <button id="download-btn" class="btn btn-download">ğŸ“¥ Download Report (PDF)</button>
            </div>
        {% endif %}

        <div class="content">
            <div class="section">
                <h2>ğŸ“¤ Upload an Image</h2>
                <form action="/upload" method="POST" enctype="multipart/form-data" class="upload-form">
                    <input type="file" name="file" accept="image/*" required>
                    <input type="hidden" name="language" id="language-hidden">
                    <button type="submit" class="btn btn-primary">ğŸ“¤ Upload Image</button>
                </form>
            </div>

            <div class="divider">OR</div>

            <div class="section">
                <h2>ğŸ“· Capture from Camera</h2>
                <a href="/capture" id="capture-link" class="btn btn-secondary">ğŸ“· Capture from Camera</a>
            </div>
        </div>

        <footer class="footer">
            <p>Supported formats: PNG, JPG, JPEG, GIF</p>
            <p>Features: Fruit Analysis â€¢ Confidence Score â€¢ PDF Reports â€¢ Dark Mode</p>
        </footer>
    </div>

    <script>
        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const htmlElement = document.documentElement;

        // Load dark mode preference
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) {
            htmlElement.classList.add('dark-mode');
            darkModeToggle.textContent = 'â˜€ï¸';
        }

        darkModeToggle.addEventListener('click', () => {
            htmlElement.classList.toggle('dark-mode');
            const isNowDark = htmlElement.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isNowDark);
            darkModeToggle.textContent = isNowDark ? 'â˜€ï¸' : 'ğŸŒ™';
        });

        // Download PDF Report
        const downloadBtn = document.getElementById('download-btn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', async () => {
                const resultBox = document.querySelector('.result-content');
                const imagePath = '{{ last_image }}';
                const result = resultBox.textContent;

                if (!imagePath) {
                    alert('No image to report');
                    return;
                }

                try {
                    const response = await fetch('/download-report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image_path: imagePath,
                            result: result
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'fruit_analysis_report.pdf';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                    } else {
                        alert('Failed to generate report');
                    }
                } catch (error) {
                    alert('Error: ' + error);
                }
            });
        }

        // Language Change
        const languageDropdown = document.getElementById('language');
        const languageHidden = document.getElementById('language-hidden');
        const captureLink = document.getElementById('capture-link');
        
        if (languageDropdown) {
            // Set initial values
            const savedLanguage = localStorage.getItem('selectedLanguage') || 'en';
            languageDropdown.value = savedLanguage;
            languageHidden.value = savedLanguage;
            captureLink.href = `/capture?language=${savedLanguage}`;
            
            languageDropdown.addEventListener('change', (e) => {
                const selectedLang = e.target.value;
                // Save language preference
                localStorage.setItem('selectedLanguage', selectedLang);
                // Update hidden input
                languageHidden.value = selectedLang;
                // Update capture link
                captureLink.href = `/capture?language=${selectedLang}`;
            });
        }
    </script>
</body>
</html>
